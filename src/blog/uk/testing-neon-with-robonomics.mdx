---
title: Тестування Neon EVM з розумними контрактами Robonomics
date: 2022-10-03
published: true
locale: 'uk'
tags: ['Robonomics в Ethereum', 'Співпраця', 'Розумні контракти', 'Neon']
cover_image: /blog/images/testing-neon-with-robonomics/blog_cover_neon_multi-agent.jpg
description: "Метою цих тестів було підтвердити готовність платформи Neon перейти на виробничий етап з використанням розумних контрактів Robonomics, які дозволяють кібер-фізичним системам (роботам) здійснювати техніко-економічні транзакції."
abstract: ""
---

## TL;DR

Метою цих тестів було підтвердити готовність платформи [Neon](https://neon-labs.org/) перейти на виробничий етап з використанням розумних контрактів Robonomics, які дозволяють кібер-фізичним системам (роботам) здійснювати техніко-економічні транзакції.

У мережі Robonomics встановлюється взаємодія між двома сторонами: Замовником - тим, хто замовляє послугу, надсилає опис технічного завдання та переказує кошти за його виконання; Виконавцем - тим, хто виконує послугу. Було протестовано типовий сценарій, за яким укладається контракт про відповідальність між Замовником та Виконавцем - за цим слідувала перевірка результатів роботи третьою стороною та оплата комісії вузлу, який супроводжував контракт між сторонами.

У цьому прикладі використовувалася симуляція роботичного руху, якому було наказано виконати послідовність дій. Тести були успішними.

## Обсяг та Цілі Тестування

Інженери [Multi-Agent Systems](https://multi-agent.io/) працюють з [Мережею Robonomics](https://robonomics.network/) протягом кількох років. Перша реалізація Мережі Robonomics була створена для мережі Ethereum. Це набір розумних контрактів для машинного спілкування.

Основу Мережі Robonomics складає контракт [Liability](https://github.com/airalab/robonomics_contracts/blob/master/contracts/robonomics/Liability.sol), розумний контракт, який відтворює типові відносини між клієнтом послуги (Замовником) та постачальником послуг (Виконавцем), і включає технічні та економічні параметри транзакції між ними. Сторони можуть бути або автономним агентом та людиною (взаємодія людина-машина), або просто двома автономними агентами (взаємодія машина-машина). Замовник та Виконавець транслюють повідомлення з параметрамиїх техніко-економічна транзакція, а потім висновок транзакції надається спеціальним вузлом - Постачальником - який шукає відповідності цих параметрів. Постачальники контролюються [Lighthouse](https://github.com/airalab/robonomics_contracts/blob/master/contracts/robonomics/Lighthouse.sol), який є спеціальним смарт-контрактом, що виконує транзакцію, коли постачальник встановлює ринкову відповідність між сторонами.

Існують три сценарії, в яких може відбуватися виконання зобов'язання:

1. Просте зобов'язання (без перевірки кінцевого результату та без комісії, сплаченої вузлам-постачальникам)
2. Зобов'язання з комісією, сплаченою постачальнику
3. Зобов'язання з комісією для постачальника та перевіркою результатів за допомогою третьої сторони - спостерігаючої мережі.

Мета цього тесту - протестувати найскладніший, третій сценарій Robonomics на платформі Neon EVM.

## Опис сценаріїв тестування

При розвитку промислових зон та інфраструктури сучасних міст можливе поява повністю автоматизованих підприємств та послуг, які контролюються кібер-фізичними системами (CPS) та надають свої послуги як автономні агенти. У зв'язку з цим можна очікувати формування мереж автономних CPS з метою збільшення швидкості та якості комунікації у процесі виробництва та надання послуг.

Для повного використання можливостей смарт-контрактів було обрано сценарій взаємодії між двома автономними економічними агентами. Розглянемо життєвий цикл зобов'язання в мережі Robonomics:

![Цикл життя зобов'язання](/blog/images/testing-neon-with-robonomics/step-by-step-3.jpg)

На зображенні вище видно, що постачальник мережі Robonomics викликає контракт Lighthouse, який з свого боку викликає [фабрику контрактів](https://github.com/airalab/robonomics_contracts/blob/master/contracts/robonomics/Factory.sol) для створення контракту Зобов'язання. Контракт Зобов'язання містить дані про транзакцію, такі як технічне завдання, оплата за послугу, адреса валідатора та крайній термін.

Щоб дізнатися більше про можливі використання Robonomics, перегляньте сторінку Robonomics [R&D](https://wiki.robonomics.network/docs/en/r-and-d-based-on-robonomics-network/#launching-a-drone-under-the-control-of-a-decentralized-computer)!

Щоб реплікувати всю інфраструктуру Robonomics на мережі Neon, ми реалізуємо сценарій запуску робота через контракт Зобов'язання.схоже на цей [приклад](https://wiki.robonomics.network/docs/en/kuka/). Якщо скрипт може бути повторено, тоді всі функції будуть працювати.

## Результати

Вихідний код контрактів Robonomics доступний [тут](https://github.com/airalab/robonomics_contracts).
Контракти використовують багато функцій Ethereum VM, включаючи:

- ERC20 [XRT](https://github.com/airalab/robonomics_contracts/blob/master/contracts/robonomics/XRT.sol) Токен
- [Фабрика](https://github.com/airalab/robonomics_contracts/blob/master/contracts/robonomics/Factory.sol)
- Власний контракт для [ENS](https://github.com/airalab/robonomics_contracts/blob/master/contracts/ens/ENS.sol)
- [Проксі](https://github.com/airalab/robonomics_contracts/blob/master/contracts/misc/SharedCode.sol) для контрактів
- Різні модифікатори та ролі в контрактах

Адреси контрактів в мережі Neon devnet https://devnet.neonevm.org

| Назва контракту | Адреса                                    |
|----------------|--------------------------------------------|
| Міграції       | 0x1DC538bE2C8572509a571B150f11aB55E52EF12E |
| ENS            | 0xa7AEa12F60D0278F01e14DBC7cc459d04d051406 |
| DutchAuction   | 0xF44F8803548D72Dbc3E28340EFD7b5328aa4F058 |
| Відповідальність| 0xA694196351dc1488e3884eCc6b650F0d8D55346a |
| Маяк           | 0x80FB5CC4c396E272b56700E6ffF5DBf4661013A8 |
| XRT            | 0x3322d7D99cF65Cab5A92073c928b5E9674af3c29 |
| PublicAmbix    | 0x85c03bE5ccFf11E79a0A776D183eF067590549d1 |
| Фабрика        | 0xCFa833bF0D46369D9024f95c9C8dFa1E4a07806C |
| PublicResolver | 0xAC9E9AA8A4cB524FE87f2b14489F1D6bE68dc46e |

[Вихідний код](https://github.com/Multi-Agent-io/neon-kuka-demo) для сценарію

## Внесені зміни до початкових контрактів

Контракти написані для Solidity 0.5.0. Тому при розгортанні та використанні контрактів зміни не потрібні.

## Робочий процес тестування

Загалом, тест полягає в надсиланні відповідних повідомлень від одного агента до іншого.

Далі, Promisor знаходить новий контракт зобов'язань в мережі та починає його виконання. Після завершення роботи надсилається повідомлення з результатом, який потім записується в контракт.

Пошагові інструкції щодо запуску можна знайти в [README.md](https://github.com/Multi-Agent-io/neon-kuka-demo/blob/main/README.md)

## Детальні результати тестування

Відео процесу

<YouTube id="https://youtu.be/fYJVF7KrNnI" posterQuality="max" />

![Зобов'язання](/blog/images/testing-neon-with-robonomics/liability.jpg)

Під час початку симуляції створюється пропозиція, і вимога надходить від Promisee, після чого за допомогою функції createLiability контракту Lighthouse створюється контракт зобов'язань. За допомогою контракту XRT токени перекладаються з адреси Promisee на адресу контракту зобов'язань.

Після того, як на Neon devnet було виявлено новий контракт зобов'язань, агент починає працювати. Результат роботи (телеметрія) записується в файл та надсилається в IPFS, хеш з файлу зберігається як результат.

Після завершення роботи контракт зобов'язань завершується за допомогою функції finalizeLiability() контракту Lighthouse, а токени перекладаються з адреси контракту зобов'язань на адреси Promisor та Validator.

Успішне виконання симуляції показало, що всі контракти працюють правильно, а платформа Neon працює.

## Недоліки платформи Neon

### Truffle не вдається отримати відповідь від мережі

Під час процесу розгортання контрактів виявилося, що проксі не завжди повертає вчасно відповідь, через що Truffle завершується помилкою:

<RbCode>

```sh
TypeError: Cannot read properties of null (reading 'from')                                    
    at Web3Інтерфейс Adapter.(<анонімний>) (/usr/lib/node_modules/truffle/build/webpack:/packages/interface-adapter/dist/adapter/web3/index.js:71:1)
    at Generator.next (<анонімний>)
    at fulfilled (/usr/lib/node_modules/truffle/build/webpack:/packages/interface-adapter/dist/adapter/web3/index.js:5:43)
    at runMicrotasks (<анонімний>)
    at processTicksAndRejections (node:internal/process/task_queues:96:5)
Truffle v5.5.23 (ядро: 5.5.23)
Node v16.14.0

Не вдалося знайти зв'язок між умовами тесту та виникненням помилки, але ймовірно, Neon EVM не може відправити квитанцію про транзакцію, і Truffle не може обробити нульову відповідь.

Якщо ми додамо тайм-аут та повторюємо тут [index.ts#L75](https://github.com/trufflesuite/truffle/blob/develop/packages/interface-adapter/lib/adapter/web3/index.ts#L75), то розгортання повинно пройти без помилок.

### Немає кінцевої точки WS/WSS

Neon EVM не має кінцевої точки WS/WSS, на відміну від Ethereum, що ускладнює підписку на події з мережі. Тому під час тестування ми моніторили події вручну.

### Немає назв подій

Neon EVM повертає досить обмежені описи подій після транзакції, наприклад:

<RbCode>

```sh
 події: {
    '0': {
      адреса: '0xCFa833bF0D46369D9024f95c9C8dFa1E4a07806C',
      хеш транзакції: '0x9894a984e6b3f6ce469c8837e11739f6e50d00216cf7c5bc3d32da106a58d50a',
      індекс журналу транзакцій: '0x1',
      хеш блоку: '0x72040f317d3a469d30327d4e1def903790b70dbede46b4f0ea4f28f30a679a80',
      номер блоку: 156073183,
      індекс транзакції: 0,
      індекс журналу: 1,
      ідентифікатор: 'log_e51e2f9f',
      повернені значення: Результат {},
      подія: невизначено,
      підпис: null,
      raw: [Об'єкт]
    },
...
```
</RbCode>

Замість 0, 1 і т. д. ми очікували побачити названі події.

## Висновок

Використовуючи платформу Neon EVM, успішно протестовано сценарій, за яким укладено договір про відповідальність між Обіцяючим та Обіцянком з подальшою перевіркою результату виконаної роботи третьою стороною. Крім того, брав участь Постачальник, який перевірив відповідність подання та попиту між сторонами та отримав комісію за цю роботу.

У демонстрації використовувалася симуляція робота-руки, яка була найнята для виконання послідовності дій. В результаті роботи робот відправив файл з телеметрією, отриманою під час завдання.

Незважаючи на деякі особливості у роботі мережі, в кінці всі участь угоди продемонстрували свою працездатність в середовищі Neon.